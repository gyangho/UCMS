<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UCMS-ì‹ ì…ë¶€ì› ì‘ë‹µì ëª©ë¡</title>
  <link rel="stylesheet" href="../../styles/recruit/recruit_responses.css" />
</head>

<%-include('../header.ejs')%>

  <body>

    <!--ê²€ìƒ‰ ë‚´ì—­ ìœ ì§€ë¥¼ ìœ„í•œ ë³€ìˆ˜ ì €ì¥-->
    <script>
      const currentSearch = "<%= search || '' %>";
      const currentColumn = "<%= column || '' %>";

      // sessionStorageì—ì„œ currentFormId í™•ì¸ ë° URLì— ì¶”ê°€
      window.addEventListener('DOMContentLoaded', function () {
        const currentFormId = sessionStorage.getItem('currentFormID');
        if (currentFormId && !window.location.search.includes('formId=')) {
          console.log(currentFormId);
          const url = new URL(window.location);
          url.searchParams.set('formId', currentFormId);
          window.location.href = url.toString();
        }
      });
    </script>

    <div class="container">
      <div class="header">
        <div class="header-top">
          <h1>ì‹ ì…ë¶€ì› ì‘ë‹µì ëª©ë¡</h1>
          <form method="POST" action="/recruit/sync" class="sync-container">
          í˜„ì¬ í¼ URL<input size="10"type="text" name="formURL" value="<%=currentForm.title || '' %>" disabled />
          <input type="text" name="formId" class="hidden" value="<%=currentForm.id%>">
          <button type="button" id="URLChangeBtn" class="btn-url-change">ë³€ê²½</button>
          <button type="submit" id="syncBtn" class="btn-sync" title="ë™ê¸°í™”">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon-sync" viewBox="0 0 24 24" width="24" height="24"
              fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 2v6h-6" />
              <path d="M3 22v-6h6" />
              <path d="M3.51 9a9 9 0 0114.14-3.36L21 8" />
              <path d="M20.49 15a9 9 0 01-14.14 3.36L3 16" />
            </svg>
          </button>
        </form>
        </div>
        <!-- ì •ë ¬ ê¸°ì¤€ ì„ íƒ -->
        <div class="sort-container">
          <label for="sortBy">ì •ë ¬ ê¸°ì¤€:</label>
          <select id="sortBy" name="sortBy" onchange="changeSort(this.value)">
            <option value="id" <%= (sortBy === 'id' || !sortBy) ? 'selected' : '' %>>ì‘ë‹µìˆœ</option>
            <option value="student_id" <%= sortBy === 'student_id' ? 'selected' : '' %>>í•™ë²ˆìˆœ</option>
            <option value="name" <%= sortBy === 'name' ? 'selected' : '' %>>ì´ë¦„ìˆœ</option>
            <option value="major" <%= sortBy === 'major' ? 'selected' : '' %>>í•™ê³¼ìˆœ</option>
          </select>
        </div>  
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <!--ë¶€ì› ëª©ë¡ í…Œì´ë¸” í—¤ë”-->
              <th data-column="student_id">
                í•™ë²ˆ <span class="search-toggle">ğŸ”</span>
                <!--ê²€ìƒ‰ ì°½-->
                <div class="search-input-container hidden" id="student_id">
                  <input type="text" class="search-input" placeholder="í•™ë²ˆ" size="8" maxlength="8" />
                  <button class="icon-btn close-search">âŒ</button>
                </div>
              </th>
              <th data-column="name">
                ì´ë¦„ <span class="search-toggle">ğŸ”</span>
                <!--ê²€ìƒ‰ ì°½-->
                <div class="search-input-container hidden" id="name">
                  <input type="text" class="search-input" placeholder="ì´ë¦„" size="5" maxlength="8" />
                  <button class="icon-btn close-search">âŒ</button>
                </div>
              </th>
              <th data-column="major">
                í•™ê³¼(ë¶€) <span class="search-toggle">ğŸ”</span>
                <!--ê²€ìƒ‰ ì°½-->
                <div class="search-input-container hidden" id="major">
                  <input type="text" class="search-input" placeholder="í•™ê³¼(ë¶€)" size="8" maxlength="10" />
                  <button class="icon-btn close-search">âŒ</button>
                </div>
              </th>
              <th data-column="phone">
                ì „í™”ë²ˆí˜¸ <span class="search-toggle">ğŸ”</span>
                <!--ê²€ìƒ‰ ì°½-->
                <div class="search-input-container hidden" id="phone">
                  <input type="text" class="search-input" placeholder="ì „í™”ë²ˆí˜¸" size="10" maxlength="16" />
                  <button class="icon-btn close-search">âŒ</button>
                </div>
              </th>
              <th data-column="gender">
                ì„±ë³„ <span class="search-toggle">ğŸ”</span>
                <!--ê²€ìƒ‰ ì°½-->
                <div class="search-input-container hidden" id="gender">
                  <select class="search-input">
                    <option value="" disabled selected>ì„±ë³„</option>
                    <option value="ë‚¨ì">ë‚¨ì</option>
                    <option value="ì—¬ì">ì—¬ì</option>
                  </select>
                  <button class="icon-btn close-search">âŒ</button>
                </div>
              </th>
              <th data-column="rating">
                í‰ê°€ <span class="search-toggle">ğŸ”</span>
                <!--ê²€ìƒ‰ ì°½-->
                <div class="search-input-container hidden" id="rating">
                  <select class="search-input">
                    <option value="" disabled selected>í‰ê°€</option>
                    <option value="ëŒ€ê¸°">ëŒ€ê¸°</option>
                    <option value="ë¶ˆí•©ê²©">ë¶ˆí•©ê²©</option>
                    <option value="ëŠë³„">ëŠë³„</option>
                    <option value="ëŠê´œ">ëŠê´œ</option>
                    <option value="ëŠì¢‹">ëŠì¢‹</option>
                    <option value="í•©ê²©">í•©ê²©</option>
                  </select>
                  <button class="icon-btn close-search">âŒ</button>
                </div>
              </th>
            </tr>
          </thead>
          <!--ì‘ë‹µ ëª©ë¡ ë°ì´í„°-->
          <tbody>
            <% recruitingMembers.forEach(m=> { %>
              <tr class="response-row" data-response-id="<%= m.response_id %>" style="cursor: pointer;">
                <td style="white-space: nowrap">
                  <%= m.student_id %>
                </td>
                <td style="white-space: nowrap">
                  <%= m.name %>
                </td>
                <td>
                  <%= m.major %>
                </td>
                <td>
                  <%= m.phone %>
                </td>
                <td>
                  <%= m.gender %>
                </td>
                <td>
                  <select class="rating-select" data-response-id="<%= m.response_id %>"
                    data-current-rating="<%= m.rating %>">
                    <option value="ëŒ€ê¸°" <%=m.rating==='ëŒ€ê¸°' ? 'selected' : '' %>>ëŒ€ê¸°</option>
                    <option value="ë¶ˆí•©ê²©" <%=m.rating==='ë¶ˆí•©ê²©' ? 'selected' : '' %>>ë¶ˆí•©ê²©</option>
                    <option value="ëŠë³„" <%=m.rating==='ëŠë³„' ? 'selected' : '' %>>ëŠë³„</option>
                    <option value="ëŠê´œ" <%=m.rating==='ëŠê´œ' ? 'selected' : '' %>>ëŠê´œ</option>
                    <option value="ëŠì¢‹" <%=m.rating==='ëŠì¢‹' ? 'selected' : '' %>>ëŠì¢‹</option>
                    <option value="í•©ê²©" <%=m.rating==='í•©ê²©' ? 'selected' : '' %>>í•©ê²©</option>
                  </select>
                </td>
              </tr>
              <% }) %>
          </tbody>
        </table>
      </div>
      <!--í˜ì´ì§€ ë¶„ë¦¬-->
      <div class="pagination">
        <% for (let i=1; i <=totalPages; i++) { %>
          <a href="/recruit/responses?page=<%= i %>&limit=<%= limit %>&column=<%= column %>&search=<%= search %>&sortBy=<%= sortBy || 'id' %>"
            class="page-item <%= currentPage == i ? 'active' : '' %>">
            <%= i %>
          </a>
          <% } %>
      </div>

    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script type="module" src="../../js/recruit/recruit_response.js"></script>

    <script>
      // ì •ë ¬ ê¸°ì¤€ ë³€ê²½ í•¨ìˆ˜
      function changeSort(sortBy) {
        const url = new URL(window.location);
        url.searchParams.set('sortBy', sortBy);
        url.searchParams.set('page', '1'); // ì •ë ¬ ë³€ê²½ ì‹œ ì²« í˜ì´ì§€ë¡œ ì´ë™
        window.location.href = url.toString();
      }
      
      // í‰ê°€ select ë³€ê²½ ì‹œ DB ì—…ë°ì´íŠ¸
      document.addEventListener('DOMContentLoaded', function () {
        const ratingSelects = document.querySelectorAll('.rating-select');

        ratingSelects.forEach(select => {
          select.addEventListener('change', async function () {
            const responseId = this.getAttribute('data-response-id');
            const newRating = this.value;
            const currentRating = this.getAttribute('data-current-rating');

            // í˜„ì¬ ê°’ê³¼ ê°™ìœ¼ë©´ ì—…ë°ì´íŠ¸í•˜ì§€ ì•ŠìŒ
            if (newRating === currentRating) {
              return;
            }

            try {
              const response = await fetch('/api/recruit/update-rating', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  form_id: '<%= currentForm.id %>',
                  response_id: responseId,
                  rating: newRating
                })
              });

              if (response.ok) {
                // ì„±ê³µ ì‹œ í˜„ì¬ ê°’ ì—…ë°ì´íŠ¸
                this.setAttribute('data-current-rating', newRating);
                console.log('í‰ê°€ ì—…ë°ì´íŠ¸ ì„±ê³µ:', newRating);
              } else {
                // ì‹¤íŒ¨ ì‹œ ì›ë˜ ê°’ìœ¼ë¡œ ë˜ëŒë¦¬ê¸°
                this.value = currentRating;
                console.error('í‰ê°€ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');
              }
            } catch (error) {
              // ì—ëŸ¬ ì‹œ ì›ë˜ ê°’ìœ¼ë¡œ ë˜ëŒë¦¬ê¸°
              this.value = currentRating;
              console.error('í‰ê°€ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜:', error);
            }
          });
        });

        // í–‰ í´ë¦­ ì´ë²¤íŠ¸
        const responseRows = document.querySelectorAll('.response-row');
        responseRows.forEach(row => {
          row.addEventListener('click', function (e) {
            // select í´ë¦­ ì‹œì—ëŠ” ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ì§€ ì•ŠìŒ
            if (e.target.classList.contains('rating-select')) {
              return;
            }

            const responseId = this.getAttribute('data-response-id');
            const detailUrl = `/recruit/detail?responseId=${responseId}&formId=${sessionStorage.getItem('currentFormID')}`;
            window.open(detailUrl, '_blank');
          });
        });
      });
    </script>

  </body>

  <div id="modal-overlay" class="hidden">
  </div>

</html>